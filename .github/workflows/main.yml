name: IP Data Daily Processor

on:
  workflow_dispatch:    # 显式声明手动触发配置
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
  schedule:
    - cron: '1 16 * * *'  # UTC时间16:01 (北京时间00:01)

permissions:
  contents: write

jobs:
  data-process:
    name: Process & Clean Data
    runs-on: ubuntu-latest
    env:
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
      # ---------- 初始化步骤 ----------
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # ---------- 设置Python环境 ----------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      # ---------- 数据处理步骤 ----------
      - name: Generate Data File
        run: |
          pip install requests urllib3
          python main.py
          echo "生成文件列表:"
          ls -l ISP_China*.dat
          
      # ---------- 智能清理步骤 ----------
      - name: Intelligent File Cleanup
        shell: bash
        run: |
          # 开启调试模式
          if [[ "$DEBUG_MODE" == "true" ]]; then
            set -x
          fi
          
          # 计算截止日期
          cutoff_date=$(date -d "7 days ago" +%Y%m%d)
          echo "清理截止日期: $cutoff_date"
          
          # 文件处理逻辑
          remaining_files=()
          for file in ISP_China*.dat; do
            if [[ -f "$file" ]]; then
              # 提取日期部分
              date_part=$(echo "$file" | grep -Eo '[0-9]{8}' | head -1)
              
              if [[ "$date_part" =~ ^[0-9]{8}$ ]]; then
                if [[ "$date_part" -lt "$cutoff_date" ]]; then
                  echo "删除过期文件: $file (${date_part} < ${cutoff_date})"
                  rm -f "$file"
                else
                  remaining_files+=("$file")
                  echo "保留文件: $file"
                fi
              else
                echo "跳过非常规文件: $file"
              fi
            fi
          done
          
          # 生成报告
          echo "剩余文件数量: ${#remaining_files[@]}"
          echo "文件名,日期" > cleanup-report.csv
          for file in "${remaining_files[@]}"; do
            echo "$file,$(date -r "$file" +%Y-%m-%d)" >> cleanup-report.csv
          done
          
      # ---------- 提交变更 ----------
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "自动更新与清理数据文件"
          file_pattern: |
            ISP_China*.dat
            cleanup-report.csv
          commit_user_name: "Data Automation"
          commit_user_email: "data@automation"
