name: IP Data Daily Processor

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æ ¸å¿ƒé…ç½®ï¼ˆä¿®å¤åä¼šæ˜¾ç¤ºæŒ‰é’®ï¼‰
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
  schedule:
    - cron: '1 16 * * *'

permissions:
  contents: write

jobs:
  data-process:
    name: Process & Clean Data
    runs-on: ubuntu-latest
    env:
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Generate Data File
        run: |
          pip install -r requirements.txt
          python main.py
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -l ISP_China*.dat

      - name: Intelligent File Cleanup  # é‡ç‚¹ä¿®å¤æ­¤æ­¥éª¤çš„Shellè¯­æ³•
        id: cleanup
        shell: bash
        run: |
          # ä¿®å¤1ï¼šæ¯è¡Œå‘½ä»¤ç‹¬ç«‹æ¢è¡Œï¼Œé¿å…åŒä¸€è¡Œå¤šä¸ªé€»è¾‘
          if [ "$DEBUG_MODE" = "true" ]; then set -x  # è°ƒè¯•æ¨¡å¼ï¼šå•ç‹¬ä¸€è¡Œï¼Œé€»è¾‘æ›´æ¸…æ™°
          fi
          # ä¿®å¤2ï¼šå˜é‡èµ‹å€¼ä¸ä½¿ç”¨ä¸¥æ ¼æ¢è¡Œ
          cutoff_date=$(date -d "7 days ago" +%Y%m%d) echo "CUTOFF_DATE=${cutoff_date}" >> $GITHUB_ENV
          
          remaining_files=()
          # ä¿®å¤3ï¼šforå¾ªç¯æ ¼å¼æ ‡å‡†åŒ–ï¼Œé¿å…ç¼©è¿›æ··ä¹±ï¼ˆYAMLå¯¹ç¼©è¿›æ•æ„Ÿï¼‰
          for file in ISP_China_*.dat; do if [[ ! -f "$file" ]]; then 
              continue  # è·³è¿‡éæ–‡ä»¶
            fi
            date_part=$(echo "$file" | grep -Eo '[0-9]{8}' | head -1)
            if [[ "$date_part" =~ ^[0-9]{8}$ ]]; then  # æå–æ—¥æœŸéƒ¨åˆ†
              if [ "$date_part" -lt "$cutoff_date" ]; then
 # ä¿®å¤4ï¼šechoå‘½ä»¤å‰æ— å¤šä½™ç©ºæ ¼ï¼Œä¸ä¸Šä¸€è¡Œifæ¡ä»¶ä¿æŒç¼©è¿›ä¸€è‡´
                echo "ğŸš« åˆ é™¤è¿‡æœŸæ–‡ä»¶: ${file}"  # ç¬¬54è¡Œï¼ˆåŸæŠ¥é”™è¡Œï¼‰å·²ä¿®å¤
 rm -v "$file"
              else
                remaining_files+=("$file")
              fi
            fi
          done

      - name: Auto-Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Automated Data Update'
          file_pattern: 'ISP_China_*.dat'
