name: IP Data Daily Processor

# -------------------------------------------------------------------
# è§¦å‘æœºåˆ¶
# -------------------------------------------------------------------
on:
  # å…è®¸æ‰‹åŠ¨åœ¨ GitHub é¡µé¢ä¸Šè§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging (set -x in shell steps)'
        required: false
        default: 'false'
  # æ¯æ—¥å®šæ—¶è¿è¡Œï¼ˆUTC æ—¶é—´ 16:01ï¼Œå³åŒ—äº¬æ—¶é—´å‡Œæ™¨ 00:01ï¼‰
  schedule:
    - cron: '1 16 * * *'

# æˆäºˆå·¥ä½œæµå†™å…¥ä»£ç ä»“åº“çš„æƒé™ï¼Œç”¨äºæäº¤æ›´æ”¹
permissions:
  contents: write

# -------------------------------------------------------------------
# ä¸»è¦ä»»åŠ¡
# -------------------------------------------------------------------
jobs:
  data-process:
    name: Process & Update IP Data
    runs-on: ubuntu-latest
    env:
      # å°†è¾“å…¥æˆ–é»˜è®¤å€¼è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ç¡®ä¿æ‹‰å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿ git-auto-commit-action å·¥ä½œæ­£å¸¸
          fetch-depth: 0

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Generate Data File
        run: |
          echo "Installing Python dependencies..."
          # æ£€æŸ¥å¹¶å®‰è£…è„šæœ¬æ‰€éœ€çš„åº“
          pip install requests
          
          echo "Running main.py script..."
          # è¿è¡Œä¸»è„šæœ¬ï¼Œå®ƒå°†ç”Ÿæˆæ–‡ä»¶åæ ¼å¼ä¸º ISP_ChinaYYYY-MM-DD.dat çš„æ–‡ä»¶
          python main.py
          
          echo "Generated file list:"
          ls -l ISP_China*.dat || true

      - name: Create Latest Fixed Link File # ç¡®ä¿å¯¹å¤–å¼•ç”¨çš„å›ºå®šé“¾æ¥å§‹ç»ˆæŒ‡å‘æœ€æ–°æ•°æ®
        id: latest_file_prep
        shell: bash
        run: |
          if [ "$DEBUG_MODE" = "true" ]; then set -x; fi
          
          # æ‰¾åˆ°å½“å¤©ç”Ÿæˆçš„æ–‡ä»¶åï¼ˆå‡è®¾ main.py æ€»æ˜¯ç”Ÿæˆæœ€æ–°çš„æ–‡ä»¶ï¼‰
          # ls -t æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼Œhead -1 å–ç¬¬ä¸€ä¸ª
          LATEST_FILE=$(ls -t ISP_China*.dat | head -1)

          if [ -f "$LATEST_FILE" ]; then
            # å®šä¹‰å›ºå®šæ–‡ä»¶å
            FIXED_FILENAME="ISP_China_Latest.dat"
            
            # å¤åˆ¶å†…å®¹åˆ°å›ºå®šæ–‡ä»¶ï¼Œä»¥ä¾¿å¯¹å¤–å‘å¸ƒå›ºå®šé“¾æ¥
            cp "$LATEST_FILE" "$FIXED_FILENAME"
            
            echo "âœ… Created fixed file: $FIXED_FILENAME"
            echo "Copied from: $LATEST_FILE"
          else
            echo "âŒ ERROR: New data file not found. Skipping fixed file creation."
          fi

      - name: Intelligent File Cleanup
        id: cleanup
        shell: bash
        run: |
          if [ "$DEBUG_MODE" = "true" ]; then set -x; fi
          
          # è®¡ç®—æˆªæ­¢æ—¥æœŸï¼ˆä¿ç•™æœ€è¿‘ 7 å¤©çš„æ–‡ä»¶ï¼‰
          cutoff_date=$(date -d "7 days ago" +%Y-%m-%d)
          echo "CUTOFF_DATE=${cutoff_date}"

          deleted_count=0
          # éå†æ‰€æœ‰ ISP_China æ—¥æœŸæ–‡ä»¶
          for file in ISP_China[0-9]*.dat
          do
            if [[ ! -f "$file" ]]; then
              continue
            fi

            # æå–æ—¥æœŸéƒ¨åˆ†
            date_part=$(echo "$file" | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -1)
            
            # ç¡®ä¿åªæ¸…ç†æ—¥æœŸæ–‡ä»¶ï¼Œä¸æ¸…ç† ISP_China_Latest.dat
            if [ "$file" != "ISP_China_Latest.dat" ] && [[ "$date_part" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              # æ—¥æœŸæ¯”è¾ƒï¼šå¦‚æœæ–‡ä»¶æ—¥æœŸæ—©äºæˆªæ­¢æ—¥æœŸ
              if [ "$date_part" < "$cutoff_date" ]; then
                echo "ğŸš« Deleting old file: ${file}"
                rm -v "$file"
                deleted_count=$((deleted_count + 1))
              # else
                # echo "âœ… Retaining file: ${file}"
              fi
            fi
          done
          
          echo "Total files deleted: ${deleted_count}"
          echo "Current files remaining:"
          ls -l ISP_China*.dat || true

      - name: Auto-Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Automated IP Data Update'
          # åŒ¹é…æ‰€æœ‰ ISP_China å¼€å¤´çš„ .dat æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ—¥æœŸæ–‡ä»¶å’Œ ISP_China_Latest.dat
          file_pattern: 'ISP_China*.dat'
          # git-auto-commit-action ä¼šè‡ªåŠ¨å¤„ç†æ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤çš„æ–‡ä»¶
