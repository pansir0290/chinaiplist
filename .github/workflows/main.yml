name: IP Data Daily Processor

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
  schedule:
    - cron: '1 16 * * *'

permissions:
  contents: write

jobs:
  data-process:
    name: Process & Clean Data
    runs-on: ubuntu-latest
    env:
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Generate Data File
        run: |
          # æ£€æŸ¥å¹¶å®‰è£…è„šæœ¬æ‰€éœ€çš„åº“
          pip install requests
          # è¿è¡Œä¸»è„šæœ¬ï¼Œå®ƒå°†ç”Ÿæˆæ–‡ä»¶åæ ¼å¼ä¸º ISP_ChinaYYYY-MM-DD.dat çš„æ–‡ä»¶
          python main.py
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -l ISP_China*.dat

      - name: Intelligent File Cleanup # å½»åº•ä¿®å¤Shellå‘½ä»¤è¯­æ³•
        id: cleanup
        shell: bash
        run: |
          # 1. è°ƒè¯•æ¨¡å¼ï¼ˆä¸¥æ ¼åˆ†è¡Œ+ç¼©è¿›ï¼‰
          if [ "$DEBUG_MODE" = "true" ]; then
            set -x
          fi

          # 2. è®¡ç®— cutoff_dateï¼ˆæ—¥æœŸæ ¼å¼ä¸Pythonè„šæœ¬ä¿æŒä¸€è‡´ï¼‰
          cutoff_date=$(date -d "7 days ago" +%Y-%m-%d)
          echo "CUTOFF_DATE=${cutoff_date}" >> $GITHUB_ENV

          # 3. æ¸…ç†è¿‡æœŸæ–‡ä»¶ï¼ˆforå¾ªç¯ä¸¥æ ¼ç¼©è¿›ï¼‰
          remaining_files=()
          # ä½¿ç”¨æ›´é€šç”¨çš„åŒ¹é…æ¨¡å¼æ¥æ‰¾åˆ°æ‰€æœ‰æ–‡ä»¶
          for file in ISP_China*.dat
          do
            if [[ ! -f "$file" ]]; then
              continue
            fi

            # æå–æ–‡ä»¶åä¸­çš„æ—¥æœŸï¼ˆå¦‚ISP_China2025-01-01.dat â†’ 2025-01-01ï¼‰
            date_part=$(echo "$file" | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -1)
            # éªŒè¯æ—¥æœŸæ ¼å¼
            if [[ "$date_part" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              # å¯¹æ¯”æ—¥æœŸï¼Œå­—ç¬¦ä¸²æ¯”è¾ƒåœ¨YYYY-MM-DDæ ¼å¼ä¸‹æ˜¯æœ‰æ•ˆçš„
              if [ "$date_part" \< "$cutoff_date" ]; then
                echo "ğŸš« åˆ é™¤è¿‡æœŸæ–‡ä»¶: ${file}"
                rm -v "$file"
              else
                remaining_files+=("$file") # ä¿ç•™æœ€æ–°æ–‡ä»¶
              fi
            fi
          done

      - name: Auto-Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Automated Data Update'
          # ä½¿ç”¨æ›´é€šç”¨çš„æ¨¡å¼ï¼ŒåŒ¹é…æ‰€æœ‰ ISP_China å¼€å¤´çš„ .dat æ–‡ä»¶
          file_pattern: 'ISP_China*.dat'
