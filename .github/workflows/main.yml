name: Auto Update and Clean ISP Data

on:
  schedule:
    - cron: '1 16 * * *'  # 北京时间00:01触发
  workflow_dispatch:

permissions:
  contents: write  # 关键权限设置

jobs:
  process-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Generate new data
        run: |
          pip install requests urllib3
          python main.py
          ls -lh ISP_China*.dat  # 生成后验证文件

      - name: Clean old files
        run: |
          # 获取7天前日期（UTC时区）
          cutoff_date=$(date -d "7 days ago" +%Y%m%d)
          echo "正在清理早于 $cutoff_date 的文件..."
          
          # 匹配所有数据文件并清理
          for file in ISP_China*.dat; do
            # 提取纯数字日期部分
            date_str=$(echo "$file" | grep -Eo '[0-9]{8}' | head -1)
            
            if [[ "$date_str" =~ ^[0-9]{8}$ ]]; then
              if [ "$date_str" -lt "$cutdate" ]; then
                echo "删除过期文件: $file (日期: $date_str)"
                rm -v "$file"
              else
                echo "保留有效文件: $file (日期: $date_str)"
              fi
            else
              echo "忽略格式异常文件: $file"
            fi
          done

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Auto: Update & Clean Data"
          file_pattern: |
            ISP_China*.dat
            !ISP_China_*.dat  # 反模式确保删除被提交
          commit_user_name: "Data Bot"
          commit_user_email: "data-bot@noreply.github.com"
          add_options: '-u'  # 强制更新索引
