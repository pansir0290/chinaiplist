name: IP Data Daily Processor

on:
  workflow_dispatch:    # æ˜¾å¼å£°æ˜æ‰‹åŠ¨è§¦å‘é…ç½®
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
  schedule:
    - cron: '1 16 * * *'  # UTCæ—¶é—´16:01 (åŒ—äº¬æ—¶é—´00:01)

permissions:
  contents: write   # å¿…éœ€å†™æƒé™
  actions: read

jobs:
  data-process:
    name: Process & Clean Data
    runs-on: ubuntu-latest
    env:
      DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}

    steps:
      # ---------- åˆå§‹åŒ–æ­¥éª¤ ----------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´å…‹éš†ç”¨äºå†å²æ¯”å¯¹

      # ---------- æ•°æ®å¤„ç†æ­¥éª¤ ----------
      - name: Generate Data File
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
        run: |
          pip install -r requirements.txt  # å‡è®¾æœ‰ä¾èµ–æ–‡ä»¶
          python main.py
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -l ISP_China*.dat

      # ---------- æ™ºèƒ½æ¸…ç†æ­¥éª¤ ----------
      - name: Intelligent File Cleanup
        id: cleanup
        shell: bash
        run: |
          # å¯ç”¨è°ƒè¯•æ¨¡å¼
          if [ "$DEBUG_MODE" = "true" ]; then
            set -x
          fi

          # æ—¥æœŸè®¡ç®—ï¼ˆå…¼å®¹è·¨æœˆ/è·¨å¹´ï¼‰
          cutoff_date=$(date -d "7 days ago" +%Y%m%d)
          echo "CUTOFF_DATE=${cutoff_date}" >> $GITHUB_ENV
          
          # æ–‡ä»¶æ¸…ç†é€»è¾‘
          echo "â–¶ï¸ å¼€å§‹æ‰«ææ–‡ä»¶..."
          remaining_files=()
          
          for file in ISP_China_*.dat; do
            if [[ ! -f "$file" ]]; then continue; fi
            
            # åŠ¨æ€æå–æ—¥æœŸï¼ˆæ”¯æŒå¤šç§å‘½åæ ¼å¼ï¼‰
            date_part=$(echo "$file" | grep -Eo '[0-9]{8}' | head -1)
            
            if [[ "$date_part" =~ ^[0-9]{8}$ ]]; then
              if [ "$date_part" -lt "$cutoff_date" ]; then
                echo "ğŸš« åˆ é™¤è¿‡æœŸæ–‡ä»¶: ${file} (${date_part} < ${cutoff_date})"
                rm -v "$file"
              else
                remaining_files+=("$file")
                echo "âœ… ä¿ç•™æ–‡ä»¶: ${file}"
              fi
            else
              echo "âš ï¸ å¿½ç•¥éå¸¸è§„æ–‡ä»¶: ${file}"
            fi
          done

          # ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
          echo "å‰©ä½™æ–‡ä»¶æ•°é‡: ${#remaining_files[@]}"
          printf "%-30s %s\n" "æ–‡ä»¶å" "æ—¥æœŸ" > cleanup-report.md
          for f in "${remaining_files[@]}"; do
            printf "%-30s %s\n" "$f" "$(date -r "$f" +%Y-%m-%d)" >> cleanup-report.md
          done

      # ---------- æäº¤å˜æ›´æ­¥éª¤ ----------
      - name: Auto-Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: | 
            Automated Data Update
            - æ–°å¢æ–‡ä»¶: ${{ steps.generate.outputs.new_files }}
            - åˆ é™¤æ–‡ä»¶: ${{ steps.cleanup.outputs.deleted_files }}
          file_pattern: |
            ISP_China_*.dat
            cleanup-report.md
          commit_options: '--verbose --allow-empty'
          add_options: '-u -v'
