name: IP Data Daily Processor

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
  schedule:
    - cron: '1 16 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  data-process:
    name: Process & Clean Data
    runs-on: ubuntu-latest
    env:
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Generate Data File
        run: |
          pip install requests
          python main.py
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -l ISP_China*.dat
          # å°†æœ€æ–°æ–‡ä»¶å¤åˆ¶ä¸ºé™æ€åç§°
          cp ISP_China$(date +%Y-%m-%d).dat ISP_China_latest.dat

      - name: Intelligent File Cleanup
        id: cleanup
        shell: bash
        run: |
          if [ "$DEBUG_MODE" = "true" ]; then
            set -x
          fi

          cutoff_date=$(date -d "7 days ago" +%Y-%m-%d)
          echo "CUTOFF_DATE=${cutoff_date}" >> $GITHUB_ENV

          remaining_files=()
          for file in ISP_China*.dat
          do
            if [[ ! -f "$file" ]]; then
              continue
            fi

            date_part=$(echo "$file" | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -1)
            if [[ "$date_part" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              if [ "$date_part" \< "$cutoff_date" ]; then
                echo "ğŸš« åˆ é™¤è¿‡æœŸæ–‡ä»¶: ${file}"
                rm -v "$file"
              else
                remaining_files+=("$file")
              fi
            fi
          done
          # ç¡®ä¿ä¸åˆ é™¤ ISP_China_latest.dat
          if [ -f ISP_China_latest.dat ]; then
            echo "âœ… ä¿ç•™æœ€æ–°æ–‡ä»¶: ISP_China_latest.dat"
          fi

      - name: Auto-Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Automated Data Update'
          file_pattern: 'ISP_China*.dat'

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: data-process
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create index.html
        run: |
          # ç¡®ä¿é“¾æ¥æŒ‡å‘ GitHub Pages çš„æ­£ç¡®è·¯å¾„
          REPO_URL="https://pansir0290.github.io/chinaiplist"
          echo "æ­¤é¡µé¢ä¸ºå ä½é¡µã€‚æ•°æ®æ–‡ä»¶ä½äºï¼š<a href=\"${REPO_URL}/ISP_China_latest.dat\">ç‚¹å‡»æ­¤å¤„è·å–æœ€æ–°æ–‡ä»¶</a>" > index.html
      
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
