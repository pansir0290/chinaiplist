name: IP Data Daily Processor  # 保持您初始文件的名称

on:
  workflow_dispatch:  # 手动触发核心配置（未修改）
    inputs:
      debug_mode:
        description: 'Enable debug logging'  # 保持原始英文描述
        required: false
        default: 'false'
  schedule:
    - cron: '1 16 * * *'  # 保持原始定时配置

permissions:
  contents: write

jobs:
  data-process:
    name: Process & Clean Data  # 保持原始任务名称
    runs-on: ubuntu-latest
    env:
      DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}  # 修复环境变量引用

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 拆分原步骤为独立的Python安装和数据生成（修复语法错误）
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Generate Data File
        run: |
          pip install -r requirements.txt
          python main.py
          echo "生成文件列表:"
          ls -l ISP_China*.dat

      - name: Intelligent File Cleanup  # 保持原始步骤名称
        id: cleanup
        shell: bash
        run: |
          if [ "$DEBUG_MODE" = "true" ]; then set -x; fi cutoff_date=$(date -d "7 days ago" +%Y%m%d) echo "CUTOFF_DATE=${cutoff_date}" >> $GITHUB_ENV
          remaining_files=()
          for file in ISP_China_*.dat; do
            if [[ ! -f "$file" ]]; then continue; fi
            date_part=$(echo "$file" | grep -Eo '[0-9]{8}' | head -1)
            if [[ "$date_part" =~ ^[0-9]{8}$ ]]; then
              if [ "$date_part" -lt "$cutoff_date" ]; then
 echo "🚫 删除过期文件: ${file}"
                rm -v "$file"
              else
                remaining_files+=("$file")
              fi
            fi
          done

      - name: Auto-Commit Changes  # 保持原始提交步骤名称
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Automated Data Update'
          file_pattern: 'ISP_China_*.dat'
